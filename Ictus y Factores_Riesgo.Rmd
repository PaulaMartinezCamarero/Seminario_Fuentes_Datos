---
title: "Ictus y Factores_Riesgo"
author: "Andrés Estévez, Paula Martínez"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```




```{r}
#antes de salir
save.image(file="objetos_actuales.Rdata")

#cuando te metes
load("OUTPUT/objetos_actuales.Rdata")
```



#Introducción
En nuestro seminario vamos a estudiar las altas hospitalarias por ictus, en los diferentes hospitales de Castilla y León durante cuatro años, y como estas, están relacionadas con distintos factores de riesgo.

Lo primero de todo, explicar que los factor de riesgo son características o circunstancias que atentan contra el equilibrio, contra la salud, y que causan enfermedades o muerte. [senado1999factores]

Durante el desarrollo de nuestro seminario vamos a trabajar con datos de dos factores de riesgo, los cuales son: un estilo de vida sedentario y la exposición al humo. Además, vamos a relacionar también el ictus con la calidad del aire.

El ser sedentario es un factor de riesgo del ictus, ya que "existe una significativa relación inversa entre actividad física y riesgo de ictus..., tanto en varones como en mujeres" [martinez2000factores]

Otro factor de riesgo del ictus es la exposición al humo, ya que "los fumaodres pasivos también tienen un mayor riesgo de ictus, puesto que la exposición al humo del cigarrillo aumenta el riesgo de progresión de aterosclerosis." [martinez2000factores]

La calidad del aire es otro factor de riesgo del ictus, quizás menos conocido, pero estudios confirman que "Niveles más elevados de NO el día de ingreso conlleva un aumento del riesgo de mortalidad" [suarez2024influencia]


#Objetivos

**Objetivos principales:**
1.Estudiar la cantidad de altas hospitalarias por ictus que hay en cada provincia de Castilla y León y ver como varían dependiendo del sexo y de la edad.
2.Analizar como el sedentarismo influye dependiendo de la edad en el riesgo de sufrir un ictus.
3.Estudiar la relación de estar expuesto al humo con la probabilidad de sufrir un ictus. Además, vamos a ver si hay más número de centros de ayuda para desintoxicación, en las provincias en las que más ictus haya habido.
4.Analizar si a peor calidad del aire hay más riesgo de sufrir un ictus.


#Procedencia y Descripción  de datos

Los datos han sido recabados de [Datos abiertos del gobierno de españa](https://datos.gob.es/es/) que hasta el momento contiene cerca de 90000 conjuntos de datos, distribuidos en un amplio número de temáticas.También supera las 550000 distribuciones, Además de 313 iniciativas de datos abiertos.


#Descripción y Importación de datos
**Descripción**
Contamos con 3 sets de datos en tipo *.csv*.
Este formato, **(Comma Separated Values)** son archivos de texto que en pricipio deberían estar con los caracteres separados por comas, aunque en algunos de nuestros datos se usa punto y coma en lugar de la coma.

Estos son nuestros archivos *.csv*.:
  -[calidad_aire](https://servicios.jcyl.es/esco/cargarFrmDatosHistoricos.action)
  -[sedentarismo](https://datos.gob.es/es/catalogo/ea0010587-sedentarismo-segun-sexo-y-grupo-de-edad-poblacion-de-15-y-mas-anos-identificador-api-t15-p420-a2019-p06-l0-04006-px1)
  -[exposicion_humo](https://datos.gob.es/es/catalogo/ea0010587-exposicion-al-humo-de-tabaco-en-lugares-cerrados-segun-sexo-pais-de-nacimiento-y-grupo-de-edad-poblacion-de-15-y-mas-anos-identificador-api-t15-p420-a2019-p03-l0-02026-px1)
  
También contamos con dos sets de datos *.json*.**(JavaScript Object Notation)** es un formato para almacenar e intercambiar datos.

Estos son nuestros archivos *.json*.:
  -[altas_hospitalarias_ictus](https://datos.gob.es/es/catalogo/a07002862-altas-hospitalarias-con-diagnostico-de-ictus)
  -[centros_servicios_saisde](https://servicios.ine.es/wstempus/jsCache/es/DATOS_TABLA/65334?tip=AM&)
Este último proviene del **Instituto Nacional de Estadística (INE)**.



  
#Manipulación de datos

#Importación de datos

#Importamos los datos de las altas hospitalarias por ictus


```{r}
library(rjson)
altas_hospitalarias_ictus <- fromJSON(file="INPUT/data/altas_hospitalarias_ictus.json")
```
#Ictus, edad y sexo
-Para resolver el primer objetivo vamos a:
  - 1 Obtener las edades de todos los pacientes para ver si la edad es un factor                 determinante en el aumento de los ictus.
```{r}
altas_hospitalarias_ictus %>%
  spread_all() %>%
  gather_object %>%
  json_types %>%
  count(name, type)

```

```{r}
altas_hospitalarias_ictus %>%
  enter_object(fields) %>%
  gather_object %>%
  spread_all %>%
  json_types%>%
  count(name, type)
```
Calculamos conteo por edad

```{r}
library(tidyverse)
library(rjson)
library(tidyjson)

edades_total <- altas_hospitalarias_ictus %>%
  spread_all %>%               
  enter_object("fields") %>%     
  spread_all() %>% 
  #con gather_object nos muestra 220,888 resultados
  rename(Edad = edad) %>%         
  select(Edad)

```
 
 
 
```{r}
#edades_total$Edad
source("INPUT/functions/total_por_edad.R")
resultados_edad <- total_por_edad(edades_total)
print(resultados_edad)

```

```{r}
regresion_edad_ictus <- lm(Conteo~poly(Edad,3),data=resultados_edad)
summary(regresion_edad_ictus)
```

```{r}
ggplot(data=resultados_edad, aes(x=Edad,y=Conteo))+
  geom_point()+
  geom_smooth()
```

  - 2 Obtener el numero de hombres y mujeres para ver si el sexo influye en la cantidad de        ictus

conteo por sexo

```{r}
library(tidyverse)
library(rjson)
library(tidyjson)

sexototal <- altas_hospitalarias_ictus %>%
  spread_all %>%               
  enter_object("fields") %>%     
  spread_all() %>% 
  #con gather_object nos muestra 220,888 resultados
  rename(Sexo = sexo) %>%         
  select(Sexo)
total_sexo <- sexototal$Sexo
#total_sexo
```

```{r}
source("INPUT/functions/total_por_sexo.R")
resultados_sexo <- total_por_sexo(total_sexo)
print(resultados_sexo)


```

```{r}
regresion_sexo_ictus <- lm(Conteo~Sexo,data=resultados_sexo)
summary(regresion_sexo_ictus)
```
```{r}
#ggplot(data=resultados_sexo, aes(x=Sexo,y=Conteo))+
  #geom_point()+
  #geom_smooth()
```

Relacionamos la edad con el sexo

```{r}
str(resultados_edad)
str(resultados_sexo)
resultados_combinados <- data.frame(
  resultados_edad,
  resultados_sexo
)
resultados_combinados
resultados_combinados$Conteo_Final <- resultados_combinados$Conteo

# Elimina la columna innecesaria 'Conteo.1'
resultados_combinados <- resultados_combinados[, c("Edad", "Sexo", "Conteo_Final")]

# Mostrar el resultado final
head(resultados_combinados)

#tutoria

```





 - 3 Juntar la edad con el sexo para ver la influencia de ambos factores en los ictus
  
Grupos de mujeres segun las edades




  - 4 Obtener el numero de casos por provincias para empezar a relacionarlo con los            siguientes objetivos
  
```{r}
Provincias <- altas_hospitalarias_ictus%>%
  spread_all()%>%
  enter_object(fields)%>%
  rename(Provincia=fields.provincia)%>%
  select(Provincia)
Provincias$Provincia <- ifelse(Provincias$Provincia == "Ávila", "Avila", Provincias$Provincia)
Provincias

```

```{r}
source("INPUT/functions/ictus_por_provincia.R")
ictus_por_provincia(Provincias$Provincia)
```



#Importamos los datos de la calidad del aire
```{r}
library(readr)
calidad_aire <- read_csv("INPUT/data/calidad_aire.csv")
#View(calidad_aire)
```

#Importamos los datos de sedentarismo

```{r} 

library(readr)
sedentarismo <- read_delim("INPUT/data/sedentarismo.csv", 
    delim = ";", escape_double = FALSE, na = "No consta", 
    trim_ws = TRUE)
#View(sedentarismo)
```


#Importamos los datos exposición al humo
```{r}
library(readr)
exposicion_humo <- read_delim("INPUT/data/exposicion_humo.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)
#View(exposicion_humo)
```

#Importamos los datos de los centros de desintoxicación

```{r}
library(tidyverse)
library(rjson)
centros_servicios_saisde <- fromJSON(file = "INPUT/data/centros_servicios_saisde.json")
#centros_servicios_saisde
#head(centros_servicios_saisde)
library(tidyjson)
Centros<- centros_servicios_saisde %>%
  spread_all() %>%
  count(provincia = fields.provincia)
Centros$provincia[9]="Avila"

print(Centros)

ordenadas <- arrange(Centros,Centros$provincia)
ordenadas

#View() ya tenemos los datos que queremos asiq no nos metemos mas adentro
  
```




Probamos a hacer las linea 854 y 861 luego










#Importamos función que imprime los habitantes de castilla y león por provincias
```{r}
source("INPUT/functions/poblacion_cyl.R")
poblacion_cyl
str(poblacion_cyl)
```
Para tener una referencia entre los centros de desintoxicación por provincia con el número de habitantes de esa provincia calcularemos cuál es el número de habitantes por centro; Con el obetivo de ver realmente si hay más ictus en aquellas provincias donde el número de habitantes por centro es menor y la el consumo de drogas es un factor significativo en los ictus o por el contrario no lo es.


```{r}
pob_centros <- full_join(poblacion_cyl,ordenadas)
tabla <- pob_centros%>%
  select(provincia,Poblacion_total,n)
source("INPUT/functions/divide.R")
hab_centro <- divide(tabla$Poblacion_total,tabla$n)
#faltaria indicar que con que provincia se corresponden esos datos.
tabla$hab_centro <- hab_centro
resultado <- tabla %>%
  select(provincia, hab_centro)
print(resultado)

```


Lo lógico es esperar que en las provincias que cuentan con un menor número de habitantes, haya menor número de ictus y menor número de centros de desintoxicación.

```{r}

#Daba un error de que ictus_por_provincia_ictus no podia ponerse en la regresión multiple porque era una función, por lo que lo he convertido en dataframe
numero_ictus <- ictus_por_provincia(Provincias)
df <- as.data.frame(numero_ictus)
df$prov <-c("Avila","Burgos","León","Palencia","Salamanca","Segovia","Soria","Valladolid","Zamora")


#rownames(df)=c

#Y ahora da otro error porque dice que hay un numero diferente de filas, esto es porque en poblacion_cyl aparece tb la población total de cyl, para que desaparezca el error debemos quitar la ultima fila.

pob_lo_que_quiero <- poblacion_cyl%>%
  select(provincia, Poblacion_total)
pob_lo_que_quiero

pob_cyl_sin_ult_fila <- pob_lo_que_quiero[1:9,]
pob_cyl_sin_ult_fila
str(pob_cyl_sin_ult_fila)
#libpob_cyl_sin_ult_fila#library("dplyr")
#Centros
arrange(.data=ordenadas,(ordenadas$provincia))

datos <- data.frame(pob=pob_cyl_sin_ult_fila,
                    centros= arrange(.data=ordenadas,(ordenadas$provincia)),
                    num_ictus=df)
str(datos)
datos



```

```{r}
library(tidyverse)
library(ggplot2)


grafica <- datos %>%
  ggplot(mapping = aes(x = reorder(pob.provincia, num_ictus.numero_ictus), y = num_ictus.numero_ictus)) +
  geom_bar(stat = "identity", aes(fill = centros.n)) +
  scale_fill_gradient(low = "peachpuff", high = "red", space = "Lab", na.value = "grey50", guide = "colourbar") +
  labs(x = "Provincias", y = "Número de ictus", fill = "Centros detox") +
  scale_y_continuous(expand = expansion(mult = c(0, .1))) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust = 1))

grafica

```


Gráfica en la que aparece representado el número de centros por se compara el número de centros por provincia con el número de ictus en esas mismas provincias:
```{r}
library(ggplot2)
grafica2 <- datos%>%
   ggplot(mapping = aes(x = reorder(pob.provincia, num_ictus.numero_ictus), y = centros.n)) +
  geom_bar(stat = "identity",fill="blue") +
  labs(x = "Provincias", y = "Número de centros") +
  scale_y_continuous(expand = expansion(mult = c(0, .1))) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust = 1))
grafica2
  
```


Gráfica en la que representamos el número de habitantes por centro para cada provincia:
```{r}

resultado
resultado_sin_ult_fila=resultado[1:9,]
str(resultado_sin_ult_fila)

library(ggplot2)
grafica3 <-
  ggplot(mapping = aes(x = reorder(datos$pob.provincia, datos$num_ictus.numero_ictus), y = resultado_sin_ult_fila$hab_centro)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(x = "Provincias", y = "Número habitantes por centro") +
  scale_y_continuous(expand = expansion(mult = c(0, .1))) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust = 1))
grafica3

```
```{r}
library(dplyr)
tabla_centros <- tibble(Provincia=datos$pob.provincia,
                        Poblacion_total_cyl=pob_cyl_sin_ult_fila$Poblacion_total,
                        Numero_centros=datos$centros.n,
                        Habitantes_por_centro=resultado_sin_ult_fila$hab_centro)
tabla_centros
```


#Ictus y sedentarismo

#Ictus y exposición al humo

#Ictus y calidad del aire



#Conclusiones


